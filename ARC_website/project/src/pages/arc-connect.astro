---
import Layout from '../layouts/Layout.astro';
import { Html5Qrcode } from 'html5-qrcode';
---
<Layout title="ARC configuration">
    <div class="max-w-xl mx-auto mt-10 p-6 bg-white dark:bg-gray-900 rounded-lg shadow-md">
        <h2 class="text-2xl font-semibold text-gray-800 dark:text-white mb-4">üì° Send File to Raspberry Pi</h2>

        <label for="ip" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Enter or Scan Raspberry Pi IP:</label>
        <input
                type="text"
                id="ip"
                placeholder="192.168.x.x"
                class="w-full p-2 mb-4 mt-1 rounded border dark:border-gray-600 bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-white"
        />

        <div class="mb-4">
            <div id="qr" class="rounded border border-gray-300 dark:border-gray-600 overflow-hidden aspect-video bg-black"></div>
            <button
                    onclick="startQR()"
                    class="mt-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded shadow transition"
            >
                üé• Scan QR Code
            </button>
        </div>

        <form id="uploadForm" class="space-y-4">
            <div>
                <label for="file" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Choose file to send:</label>
                <input type="file" id="file" required class="block mt-1" />
            </div>
            <button
                    type="submit"
                    class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded shadow transition"
            >
                üì§ Send to Pi
            </button>
        </form>

        <p id="status" class="mt-4 text-sm text-gray-700 dark:text-gray-300"></p>
    </div>

    <script>
        const ipInput = document.getElementById('ip');
        const form = document.getElementById('uploadForm');
        const status = document.getElementById('status');

        function startQR() {
            const qrRegion = document.getElementById('qr');
            qrRegion.innerHTML = ""; // clear previous scanner

            const qr = new Html5Qrcode("qr");

            qr.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decoded) => {
                    ipInput.value = decoded;
                    qr.stop().then(() => qr.clear()).catch(console.error);
                },
                (err) => {
                    console.warn("QR scan error", err);
                }
            ).catch(err => {
                console.error("Failed to start QR scanner", err);
            });
        }

        form.onsubmit = async (e) => {
            e.preventDefault();
            const ip = ipInput.value.trim();
            const file = document.getElementById('file').files[0];
            if (!ip || !file) return alert("Enter IP and select a file.");

            const formData = new FormData();
            formData.append("file", file);

            try {
                const response = await fetch(`http://${ip}:5000/upload`, {
                    method: "POST",
                    body: formData,
                });

                status.textContent = response.ok
                    ? "‚úÖ File sent successfully!"
                    : "‚ùå Error uploading file.";
            } catch (err) {
                status.textContent = "‚ùå Could not connect to ARC.";
                console.error(err);
            }
        };
    </script>

</Layout>
